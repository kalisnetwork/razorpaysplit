<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Form</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }

        .form-container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 350px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background-color: #5cb85c;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #4cae4c;
        }
    </style>
</head>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Form</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }

        .form-container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 350px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background-color: #5cb85c;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #4cae4c;
        }
    </style>
</head>
<body>
<div class="form-container">
    <h2>Business Listing Payment</h2>
    <form id="payment-form">
        <div class="form-group">
            <label for="shop-owner">Shop Owner Name</label>
            <input type="text" id="shop-owner" name="shop-owner" required>
        </div>
        <div class="form-group">
            <label for="linked-account">Field Executive</label>
            <select id="linked-account" name="linked-account" required>
                <option value="acc_PhJnq5lEc2Hxyn">Field Executive 1</option>
            </select>
        </div>
        <div class="form-group">
            <label for="amount">Total Amount (INR)</label>
            <input type="number" id="amount" name="amount" required>
        </div>
        <div class="form-group">
            <label for="commission-amount">Commission Amount (INR)</label>
            <input type="number" id="commission-amount" name="commission-amount" required>
        </div>
        <button type="button" id="pay-button">Pay Now</button>
    </form>
</div>

<script>
    document.getElementById('pay-button').addEventListener('click', initiatePayment);

    async function initiatePayment() {
        const amount = document.getElementById('amount').value;
        const linkedAccountId = document.getElementById('linked-account').value;
        const commissionAmount = document.getElementById('commission-amount').value;

        // Validate amounts
        if (parseInt(commissionAmount) >= parseInt(amount)) {
            alert('Commission amount must be less than total amount');
            return;
        }

        try {
            // Create order with transfer configuration
            const response = await fetch('/api/payments/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    amount: parseInt(amount),
                    currency: 'INR',
                    receipt: `receipt_${Date.now()}`,
                    linkedAccountId,
                    commissionAmount: parseInt(commissionAmount)
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message);
            }
            const data = await response.json();

            // Initialize Razorpay
            const options = {
                key: 'rzp_live_LtxqAtCR7grTov',
                amount: data.order.amount,
                currency: "INR",
                name: "Business Listing App",
                description: "Payment with Instant Commission Transfer",
                order_id: data.order.id,
                handler: async (response) => {
                    try {
                        // Verify payment and process instant transfer
                        const verifyResponse = await fetch('/api/payments/process', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                order_id: response.razorpay_order_id,
                                payment_id: response.razorpay_payment_id,
                                signature: response.razorpay_signature,
                                amount: parseInt(amount),
                                linkedAccountId,
                                commissionAmount: parseInt(commissionAmount)
                            })
                        });

                        if (!verifyResponse.ok) {
                            const errorData = await verifyResponse.json();
                            throw new Error(errorData.message);
                        }

                        const verifyData = await verifyResponse.json();
                        
                        // Show success message with transfer details
                        const params = new URLSearchParams({
                            paymentId: verifyData.data.paymentId,
                            amount: amount,
                            commission: commissionAmount,
                            transferId: verifyData.data.transfer?.id || '',
                            message: `Payment successful. Commission of â‚¹${commissionAmount} transferred instantly.`
                        });

                        window.location.href = `/success.html?${params.toString()}`;
                    } catch (error) {
                        console.error("Payment verification/transfer failed:", error);
                        alert('Payment verification/transfer failed: ' + error.message);
                    }
                },
                prefill: {
                    name: document.getElementById('shop-owner').value,
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        } catch (error) {
            console.error('Failed to initiate payment:', error);
            alert('Failed to initiate payment: ' + error.message);
        }
    }
</script>
</body>
</html>